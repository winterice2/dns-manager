---
alwaysApply: true
description: Character encoding handling for Windows/PowerShell integration
---

# ğŸ”§ Character Encoding - Windows/PowerShell Critical Issue

## ğŸš¨ THE PROBLEM: "Ğ Ğ¾Ğ¼Ğ±Ğ¸ĞºĞ¸ Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸" (Diamond Question Marks)

Windows PowerShell uses **CP866 (DOS Russian)** encoding, but Rust outputs **UTF-8**.
This causes corrupted text display in console logs.

### Symptoms:

```
âŒ BAD: ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½â ¬ï¿½ ï¿½ 1.1.1.1 ï¿½ï¿½ ï¿½ 32 ï¿½ï¿½ï¿½â ¬ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½:
âŒ BAD: ï¿½â¢¥ï¿½ ï¿½ï¿½ 1.1.1.1: ï¿½á«® ï¿½ï¿½ï¿½ï¿½=32 ï¿½à¥¬ï¿½=19ï¿½ï¿½ TTL=59
```

### Root Cause:

- PowerShell console: CP866 encoding
- Rust `println!`: UTF-8 encoding
- No automatic conversion

## âœ… THE SOLUTION: encoding_rs + Custom Print Function

### 1. Add dependency:

```toml
[dependencies]
encoding_rs = "0.8"
```

### 2. Create encoding-aware print function:

```rust
use encoding_rs;
use std::io::{self, Write};

fn println_cp866(message: &str) {
    // Convert UTF-8 to Windows-1251 (compatible with CP866 for Russian)
    let (cow, _encoding, _had_errors) = encoding_rs::WINDOWS_1251.encode(message);
    let bytes = cow.as_ref();

    // Direct write to stdout with correct encoding
    let _ = io::stdout().write_all(bytes);
    let _ = io::stdout().write_all(b"\r\n");
}
```

### 3. Replace ALL println! with println_cp866:

```rust
// âŒ BAD - causes encoding corruption
println!("Test-Connection failed for {}", ip);

// âœ… GOOD - proper encoding
println_cp866(&format!("Test-Connection failed for {}", ip));
```

## ğŸ“‹ IMPLEMENTATION RULES

### 1. Console Output Standards

- **ALWAYS** use `println_cp866()` instead of `println!()`
- **NEVER** mix UTF-8 and CP866 in same output
- **TEST** on Russian Windows systems

### 2. Error Message Encoding

```rust
// âœ… GOOD - properly encoded errors
println_cp866(&format!("ping.exe ping to {} failed: {}", ip, e));

// âœ… GOOD - debug info encoded
println_cp866(&format!("Raw ping output: {:?}", raw_output));
```

### 3. String Formatting

```rust
// âœ… GOOD - format then encode
let msg = format!("Provider {}: {}ms", name, ping_time);
println_cp866(&msg);
```

## ğŸš¨ CRITICAL REMINDERS

- **ALL** console output must be CP866 encoded
- **TEST** on Russian locale Windows systems
- **NEVER** use `println!` for user-visible messages
- **ALWAYS** encode error messages and debug info
- **CHECK** encoding when adding new logging

## ğŸ” DETECTION PATTERNS

Watch for these anti-patterns:

- `println!(.*)` in network/command code
- Raw string output to console
- Missing encoding in error handling
- Debug prints with special characters

## ğŸ§ª TESTING REQUIREMENTS

- Test on Russian Windows locale
- Verify no diamond question marks
- Check special characters display correctly
- Validate error message readability
